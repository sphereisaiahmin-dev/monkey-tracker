<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Flight Log Form</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <div id="authOverlay" class="auth-overlay" role="dialog" aria-modal="true" hidden>
    <div class="auth-card">
      <div class="auth-header">
        <h1>Flight Log Access</h1>
        <p class="help">Sign in with your thesphere.com account or create one to continue.</p>
      </div>
      <div class="auth-tabs" role="tablist">
        <button id="authTabLogin" class="auth-tab is-active" type="button" role="tab" data-auth-target="login" aria-selected="true">Sign in</button>
        <button id="authTabRegister" class="auth-tab" type="button" role="tab" data-auth-target="register" aria-selected="false">Create account</button>
      </div>
      <form id="loginForm" class="auth-form is-active" data-auth-form="login" autocomplete="on">
        <label for="loginEmail">Email</label>
        <input id="loginEmail" name="email" type="email" autocomplete="email" required placeholder="first.last@thesphere.com" />
        <label for="loginPassword">Password</label>
        <input id="loginPassword" name="password" type="password" autocomplete="current-password" required />
        <button type="submit" class="btn primary auth-submit">Sign in</button>
      </form>
      <form id="registerForm" class="auth-form" data-auth-form="register" autocomplete="on" aria-hidden="true">
        <div class="grid auth-grid">
          <div class="col-6">
            <label for="regFirstName">First name</label>
            <input id="regFirstName" name="firstName" type="text" autocomplete="given-name" required />
          </div>
          <div class="col-6">
            <label for="regLastName">Last name</label>
            <input id="regLastName" name="lastName" type="text" autocomplete="family-name" required />
          </div>
        </div>
        <label for="regEmail">Email (auto-generated)</label>
        <input id="regEmail" name="email" type="email" readonly required />
        <label for="regRole">Role</label>
        <select id="regRole" name="role" required>
          <option value="pilot">Pilot</option>
          <option value="stagehand">Stagehand</option>
        </select>
        <div class="grid auth-grid">
          <div class="col-6">
            <label for="regPassword">Password</label>
            <input id="regPassword" name="password" type="password" autocomplete="new-password" required />
          </div>
          <div class="col-6">
            <label for="regPasswordConfirm">Confirm password</label>
            <input id="regPasswordConfirm" name="passwordConfirm" type="password" autocomplete="new-password" required />
          </div>
        </div>
        <p class="help">Emails follow the pattern <strong>first.last@thesphere.com</strong>.</p>
        <button type="submit" class="btn primary auth-submit">Create account</button>
      </form>
      <div id="authMessage" class="auth-message" role="alert"></div>
    </div>
  </div>
  <div id="appShell" class="app-shell">
    <aside id="configPanel" class="config" role="dialog" aria-modal="true" aria-labelledby="configTitle">
      <div class="toolbar config-header">
        <h2 id="configTitle">Workspace menu</h2>
        <button id="closeConfig" class="btn icon-btn" title="Close settings">✖️</button>
      </div>
      <nav class="config-nav" aria-label="Settings categories">
        <button type="button" class="config-nav-btn is-active" data-config-target="lead">Lead settings</button>
        <button type="button" class="config-nav-btn" data-config-target="users">User settings</button>
        <button type="button" class="config-nav-btn" data-config-target="admin">Admin settings</button>
      </nav>
      <div id="adminPinPrompt" class="pin-prompt" role="alertdialog" aria-modal="true" aria-labelledby="adminPinTitle" hidden>
        <div class="pin-card">
          <h3 id="adminPinTitle">Admin PIN required</h3>
          <p class="help">Enter the 4-digit PIN to continue.</p>
          <label for="adminPinInput">PIN</label>
          <input id="adminPinInput" type="password" inputmode="numeric" pattern="[0-9]*" maxlength="4" autocomplete="off" />
          <div class="row pin-actions">
            <button type="button" id="adminPinCancel" class="btn ghost">Cancel</button>
            <button type="button" id="adminPinSubmit" class="btn primary">Unlock</button>
          </div>
          <div id="adminPinError" class="error" role="alert" hidden>Incorrect PIN. Try again.</div>
        </div>
      </div>
      <form id="configForm" class="config-form">
        <section class="config-section grid is-active" data-config-section="lead">
          <fieldset id="staffFields" class="col-12 provider-fields">
            <legend>Pilots, monkey leads &amp; crew</legend>
            <p class="help">These read-only lists mirror your user directory. Manage accounts from the User settings tab.</p>
            <label for="pilotList">Pilots</label>
            <textarea id="pilotList" class="list-input" placeholder="e.g., Alex"></textarea>
            <label for="monkeyLeadList">Monkey leads</label>
            <textarea id="monkeyLeadList" class="list-input" placeholder="e.g., Cleo"></textarea>
            <label for="crewList">Crew</label>
            <textarea id="crewList" class="list-input" placeholder="e.g., Jamie"></textarea>
          </fieldset>
        </section>
        <section class="config-section grid" data-config-section="users" aria-hidden="true">
          <div class="col-12">
            <h3>User directory</h3>
            <p class="help">Manage pilots and stagehands. These accounts power the crew &amp; lead lists.</p>
          </div>
          <div class="col-12">
            <div id="userList" class="user-list" role="list"></div>
          </div>
          <form class="col-12 user-form" id="userFormWrap">
            <fieldset>
              <legend id="userFormTitle">Create user</legend>
              <div class="grid user-form-grid">
                <div class="col-4">
                  <label for="userFirstName">First name</label>
                  <input id="userFirstName" type="text" autocomplete="off" required />
                </div>
              <div class="col-4">
                <label for="userLastName">Last name</label>
                <input id="userLastName" type="text" autocomplete="off" required />
              </div>
              <div class="col-4">
                <label for="userRole">Role</label>
                <select id="userRole">
                  <option value="pilot">Pilot</option>
                  <option value="stagehand">Stagehand</option>
                </select>
              </div>
              <div class="col-6">
                <label for="userEmail">Email</label>
                <input id="userEmail" type="email" readonly />
              </div>
              <div class="col-3">
                <label for="userPassword">Password</label>
                <input id="userPassword" type="password" autocomplete="new-password" />
              </div>
              <div class="col-3">
                <label for="userPasswordConfirm">Confirm password</label>
                <input id="userPasswordConfirm" type="password" autocomplete="new-password" />
              </div>
            </div>
            <div class="user-form-actions row">
              <button type="button" id="userFormCancel" class="btn ghost" hidden>Cancel</button>
              <button type="button" id="userFormDelete" class="btn danger" hidden>Remove user</button>
              <div class="grow"></div>
              <button type="submit" id="userFormSubmit" class="btn primary">Save user</button>
            </div>
            <p id="userFormMessage" class="help" role="status"></p>
            </fieldset>
          </form>
        </section>
        <section class="config-section grid" data-config-section="admin" aria-hidden="true">
          <div class="col-12">
            <label for="unitLabelSelect">Unit label</label>
            <select id="unitLabelSelect" name="unitLabel">
              <option value="Drone">Drone</option>
              <option value="Monkey">Monkey</option>
            </select>
            <p class="help">Controls how units are referenced across the UI.</p>
          </div>
          <fieldset class="col-12 provider-fields data-tools">
            <legend>Data tools</legend>
            <p class="help">Refresh the show list to pull the latest records.</p>
            <button id="refreshShows" type="button" class="btn ghost">Refresh data</button>
          </fieldset>
          <fieldset id="webhookFields" class="col-12 provider-fields">
            <legend>Webhook export</legend>
            <label class="switch">
              <input id="webhookEnabled" type="checkbox" />
              <span>Enable per-entry webhook dispatch</span>
            </label>
            <p class="help">Send each recorded entry to an external endpoint using the same columns as the CSV export.</p>
            <button id="webhookConfigure" type="button" class="btn ghost" hidden>Config webhook</button>
          </fieldset>
        </section>
        <div class="config-actions row">
          <div class="grow"></div>
          <button type="button" id="cancelConfig" class="btn ghost">Cancel</button>
          <button type="submit" class="btn primary">Save settings</button>
        </div>
        <div class="config-status">
          <div id="configMessage" role="status" aria-live="polite" class="help"></div>
        </div>
      </form>
    </aside>

    <div id="appMain" class="app-main">
      <div class="topbar" role="banner">
        <div class="toolbar topbar-toolbar">
          <div class="topbar-actions">
            <button id="configBtn" class="btn icon-btn hamburger-btn" aria-haspopup="dialog" aria-expanded="false" aria-controls="configPanel" title="Open settings">
              <span class="hamburger-icon" aria-hidden="true">
                <span></span>
                <span></span>
                <span></span>
              </span>
              <span class="sr-only">Open settings</span>
            </button>
            <button id="roleHome" class="btn ghost" type="button">← Choose workspace</button>
            <div class="topbar-user" aria-live="polite">
              <span id="currentUserLabel" class="user-label"></span>
              <button id="logoutBtn" class="btn ghost small" type="button">Sign out</button>
            </div>
          </div>
          <img src="./assets/Sphere%20Logo_RGB%20_White.png" alt="Sphere" class="app-logo" />
          <div class="topbar-title">
            <span id="viewBadge" class="view-badge">Lead workspace</span>
            <div class="title-stack">
              <h1 class="app-title">Flight Log Form</h1>
              <span class="title-sub">Tracking <span id="appTitle">Drone</span> activity</span>
            </div>
          </div>
        </div>
      </div>

      <div class="container" role="main">
    <section id="landingView" class="panel landing-panel view-landing-only" aria-labelledby="landingTitle">
      <h2 id="landingTitle">Choose workspace</h2>
      <p class="lead">Select the role you need for this session.</p>
      <div class="role-options">
        <div class="role-options-main">
          <button id="chooseLead" type="button" class="btn primary role-btn">Lead</button>
          <button id="choosePilot" type="button" class="btn primary role-btn">Pilot</button>
        </div>
        <div class="role-options-archive">
          <button id="chooseArchive" type="button" class="btn primary role-btn">Archive</button>
        </div>
      </div>
      <p class="help">Lead sets up shows and manages exports. Pilot logs entries against those shows.</p>
    </section>

    <section id="archiveView" class="panel view-archive-only" aria-labelledby="archiveTitle">
      <div class="panel-header">
        <h2 id="archiveTitle">Archived shows</h2>
        <div class="panel-actions">
          <button id="refreshArchive" type="button" class="btn ghost">Refresh archive</button>
        </div>
      </div>
      <div class="grid archive-grid">
        <div class="col-4">
          <label for="archiveShowSelect">Archived show</label>
          <select id="archiveShowSelect"></select>
          <p id="archiveMeta" class="help"></p>
          <section id="archiveStats" class="archive-stats" aria-live="polite"></section>
        </div>
        <div class="col-8">
          <div id="archiveDetails" class="archive-details"></div>
          <div id="archiveEmpty" class="help">No archived shows yet. Shows are moved here 24 hours after creation and remain available for two months.</div>
          <div class="archive-actions row">
            <button id="archiveExportCsv" type="button" class="btn ghost" disabled>Export CSV</button>
            <button id="archiveExportJson" type="button" class="btn ghost" disabled>Export JSON</button>
          </div>
        </div>
      </div>
      <div class="archive-analytics" aria-live="polite">
        <div class="archive-analytics-header">
          <h3>Archive analytics</h3>
          <p class="help">Graph show statistics over time to spot trends.</p>
        </div>
        <div class="archive-analytics-controls">
          <div class="control-group">
            <span class="control-label">Metrics</span>
            <div id="archiveMetricButtons" class="metric-toggle-grid" role="group" aria-label="Archive metrics"></div>
            <p id="archiveMetricHelp" class="help small">Toggle metrics to visualise together.</p>
          </div>
          <div class="control-group">
            <span class="control-label">Primary issues</span>
            <div id="archiveIssueButtons" class="metric-toggle-grid" role="group" aria-label="Primary issue metrics"></div>
            <p class="help small">Add issue frequency metrics to the chart.</p>
          </div>
          <div class="control-group control-group-mode">
            <span class="control-label">Populate graph by</span>
            <div class="mode-toggle" role="group" aria-label="Show selection mode">
              <button id="archiveModeCalendar" type="button" class="btn toggle-btn is-active" data-archive-mode="calendar">Calendar range</button>
              <button id="archiveModeShows" type="button" class="btn toggle-btn" data-archive-mode="shows">Show picker</button>
            </div>
            <p class="help small">Choose how the show list feeds the chart.</p>
          </div>
          <div id="archiveModeControls" class="control-group"></div>
        </div>
        <div class="archive-chart-wrap">
          <canvas id="archiveStatCanvas" class="archive-chart" role="img" aria-label="Archived show statistic over time"></canvas>
          <p id="archiveStatEmpty" class="help">Select one or more shows and metrics to render the chart.</p>
          <div id="archiveDayDetail" class="archive-day-detail" hidden>
            <div class="archive-day-detail-card" role="dialog" aria-labelledby="archiveDayDetailTitle">
              <div class="archive-day-detail-header">
                <h4 id="archiveDayDetailTitle">Day breakdown</h4>
                <button id="closeArchiveDayDetail" type="button" class="btn icon-btn" aria-label="Close day breakdown">✖️</button>
              </div>
              <div id="archiveDayDetailContent" class="archive-day-detail-content"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="panel view-lead-only" aria-labelledby="showHeaderTitle">
      <div class="panel-header">
        <h2 id="showHeaderTitle">Show header</h2>
        <div class="panel-actions">
          <button id="newShow" class="btn primary">Add show</button>
        </div>
      </div>
      <div class="grid">
        <div class="col-3">
          <label for="showDate">Date</label>
          <input id="showDate" type="date" autocomplete="off" required />
        </div>
        <div class="col-3">
          <label for="showTime">Show start time</label>
          <input id="showTime" type="time" required />
        </div>
        <div class="col-6">
          <label for="showLabel">Show label or number</label>
          <input id="showLabel" type="text" placeholder="e.g., 7pm Main" required />
        </div>
        <div class="col-6">
          <label for="leadPilot">Lead Pilot</label>
          <select id="leadPilot" required></select>
        </div>
        <div class="col-6">
          <label for="monkeyLead">Monkey Lead</label>
          <select id="monkeyLead" required></select>
        </div>
        <div class="col-12">
          <label for="showNotes">Notes for the show</label>
          <textarea id="showNotes" placeholder="High-level notes"></textarea>
        </div>
      </div>
    </section>

    <section class="panel view-pilot-only" aria-labelledby="entryTitle">
      <h2 id="entryTitle">Entry form</h2>
      <div class="grid" id="entryForm">
        <div class="col-12">
          <label for="entryShowSelect">Assign to show</label>
          <select id="entryShowSelect"></select>
          <div id="pilotShowSummary" class="help">Select a show to start logging entries.</div>
        </div>
        <div class="col-2">
          <label for="unitId"><span id="unitLabel">Monkey</span> ID</label>
          <select id="unitId"></select>
          <div class="error" id="errUnit" hidden>Required</div>
        </div>
        <div class="col-2">
          <label for="planned">Planned to fly</label>
          <select id="planned">
            <option value="">Select</option>
            <option>Yes</option>
            <option>No</option>
          </select>
          <div class="error" id="errPlanned" hidden>Required</div>
        </div>
        <div class="col-2">
          <label for="launched">Launched</label>
          <select id="launched">
            <option value="">Select</option>
            <option>Yes</option>
            <option>No</option>
          </select>
          <div class="error" id="errLaunched" hidden>Required</div>
        </div>
        <div class="col-4">
          <label>Status</label>
          <div class="pills" role="group" aria-label="Status">
            <button type="button" class="pill completed" id="stCompleted" data-status="Completed" aria-pressed="false"><span class="status-dot dot-success"></span>Completed</button>
            <button type="button" class="pill nolaunch" id="stNoLaunch" data-status="No-launch" aria-pressed="false"><span class="status-dot dot-danger"></span>No-launch</button>
            <button type="button" class="pill abort" id="stAbort" data-status="Abort" aria-pressed="false"><span class="status-dot dot-warn"></span>Abort</button>
          </div>
          <div class="error" id="errStatus" hidden>Required</div>
        </div>
        <div class="col-4 issue-block hidden">
          <label for="primaryIssue">Primary issue</label>
          <select id="primaryIssue"></select>
          <div class="error" id="errPrimary" hidden>Required</div>
        </div>
        <div class="col-4 issue-block hidden">
          <label for="subIssue">Sub-issue</label>
          <select id="subIssue"></select>
        </div>
        <div class="col-4 issue-block hidden" id="otherDetailWrap">
          <label for="otherDetail">Other detail</label>
          <input id="otherDetail" type="text" placeholder="Short detail" />
          <div class="error" id="errOther" hidden>Required</div>
        </div>
        <div class="col-4 issue-block hidden">
          <label for="severity">Severity</label>
          <select id="severity">
            <option value="">Select</option>
            <option>Critical show stop</option>
            <option>Major visible</option>
            <option>Minor contained</option>
          </select>
          <div class="error" id="errSeverity" hidden>Required</div>
        </div>
        <div class="col-4 issue-block hidden">
          <label for="rootCause">Root cause draft</label>
          <select id="rootCause">
            <option value="">Select</option>
            <option>Hardware</option>
            <option>Software</option>
            <option>Ops</option>
            <option>Environment</option>
            <option>Unknown</option>
          </select>
        </div>
        <div class="col-12 issue-block hidden">
          <label>Actions taken</label>
          <div class="actions-chips" id="actionsChips" role="group" aria-label="Actions taken"></div>
        </div>
        <div class="col-3">
          <label for="operator">Operator</label>
          <select id="operator"></select>
          <div class="error" id="errOperator" hidden>Required</div>
        </div>
        <div class="col-3">
          <label for="batteryId">Battery ID</label>
          <input id="batteryId" type="text" placeholder="e.g., B-12" />
        </div>
        <div class="col-3">
          <label for="delaySec">Launch delay seconds</label>
          <input id="delaySec" type="number" step="0.1" min="0" placeholder="0.0" />
          <div class="error" id="errDelay" hidden>Must be a non-negative number</div>
        </div>
        <div class="col-3">
          <label for="commandRx">Command received</label>
          <select id="commandRx">
            <option value="">Select</option>
            <option>Yes</option>
            <option>No</option>
          </select>
        </div>
        <div class="col-9">
          <label for="entryNotes">Notes</label>
          <input id="entryNotes" type="text" placeholder="Short note" />
        </div>
        <div class="col-12 entry-actions">
          <button id="addLine" class="btn primary">Add line</button>
        </div>
      </div>
    </section>

    <section id="groups" class="view-lead-only"></section>
  </div>
  </div>
</div>

  <div id="webhookModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="webhookModalTitle" aria-hidden="true">
    <div class="modal">
      <div class="toolbar">
        <h2 id="webhookModalTitle">Webhook settings</h2>
        <button id="closeWebhookModal" class="btn icon-btn" title="Close webhook settings">✖️</button>
      </div>
      <form id="webhookForm" class="grid">
        <div class="col-12">
          <label for="webhookUrl">Webhook URL</label>
          <input id="webhookUrl" type="url" autocomplete="off" placeholder="https://example.com/webhook" />
        </div>
        <div class="col-4">
          <label for="webhookMethod">HTTP method</label>
          <select id="webhookMethod">
            <option>POST</option>
            <option>PUT</option>
          </select>
        </div>
        <div class="col-8">
          <label for="webhookSecret">Shared secret (optional)</label>
          <input id="webhookSecret" type="text" autocomplete="off" placeholder="Used for X-Drone-Webhook-Secret header" />
        </div>
        <div class="col-12">
          <label for="webhookHeaders">Additional headers (optional)</label>
          <textarea id="webhookHeaders" placeholder="One per line, e.g., Authorization: Bearer token"></textarea>
        </div>
        <div class="col-12">
          <div id="webhookPreview" class="webhook-preview" aria-live="polite"></div>
        </div>
      </form>
      <div class="sep"></div>
      <div class="row" style="justify-content:flex-end;gap:10px;">
        <button type="button" id="webhookCancel" class="btn ghost">Cancel</button>
        <button type="submit" form="webhookForm" id="webhookSave" class="btn primary">Save webhook settings</button>
      </div>
    </div>
  </div>

  <div id="editModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="editTitle">
    <div class="modal">
      <div class="toolbar">
        <h2 id="editTitle">Edit entry</h2>
        <button id="closeEdit" class="btn icon-btn" title="Close edit">✖️</button>
      </div>
      <form id="editForm" class="grid"></form>
      <div class="sep"></div>
      <div class="row" style="justify-content:flex-end;gap:10px;">
        <button type="button" id="saveEdit" class="btn primary">Save changes</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="./app.js" type="module"></script>
</body>
</html>
