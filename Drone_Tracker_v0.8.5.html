<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>drone-tracker.html</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <style>
    :root{
      --bg:#0e0f12;
      --panel:#16181d;
      --muted:#1f232b;
      --text:#e8e8ea;
      --text-dim:#a7acb8;
      --primary:#4aa3ff;
      --primary-2:#2e7bd1;
      --success:#1fc67a;
      --warn:#ffc857;
      --danger:#ff5d5d;
      --focus:#30c4ff;
      --input:#0f1115;
      --chip:#ffbe3f;
      --border:#26365a;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:14px;
      --radius-sm:10px;
      --radius-lg:18px;
      --gap:12px;
      --tap-min:44px;
      --fz:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font:500 var(--fz)/1.35 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
    }
    h1,h2,h3{margin:0 0 8px}
    h1{font-size:22px}
    h2{font-size:18px;color:var(--text-dim)}
    a{color:var(--primary);text-decoration:none}
    .container{
      max-width:1100px;
      margin:0 auto;
      padding:14px 16px 120px;
    }
    .topbar{
      position:sticky;top:0;z-index:50;
      background:linear-gradient(to bottom, rgba(14,15,18,.95), rgba(14,15,18,.85) 60%, transparent);
      backdrop-filter:saturate(1.2) blur(8px);
      padding:10px 16px 6px;
      border-bottom:1px solid var(--border);
    }
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .grow{flex:1}
    .badge{
      background:var(--chip); color:var(--text-dim); padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid var(--border)
    }
    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      margin-top:14px;
    }
    .grid{
      display:grid; gap:10px;
      grid-template-columns: repeat(12, 1fr);
    }
    .col-12{grid-column:span 12}
    .col-6{grid-column:span 6}
    .col-4{grid-column:span 4}
    .col-3{grid-column:span 3}
    .col-2{grid-column:span 2}
    @media (max-width:900px){
      .col-6,.col-4,.col-3,.col-2{grid-column:span 12}
    }
    label{font-size:12px;color:var(--text-dim);display:block;margin:4px 0 6px}
    input, select, textarea{
      width:100%;
      background:var(--input);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:10px;
      padding:12px 12px;
      min-height:var(--tap-min);
      outline:none;
      transition:.15s border, .15s box-shadow, .15s background;
      font:inherit;
    }
    #showDate, #showTime{
      background:
        linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0) 64%, rgba(255,255,255,.08) 82%, rgba(255,255,255,.16) 100%),
        var(--input);
      background-repeat:no-repeat;
      background-clip: padding-box;
    }
    textarea{min-height:84px; resize:vertical}
    input:focus, select:focus, textarea:focus, .btn:focus-visible, .chip-input input:focus{
      border-color:var(--focus);
      box-shadow:0 0 0 3px rgba(154, 210, 255, 0.95);
    }
    .btn{
      background:var(--muted);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px 14px;
      min-height:var(--tap-min);
      font-weight:700;
      cursor:pointer;
      transition:.15s transform, .15s background, .15s border-color;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
    }
    .btn:hover{background:#232733}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:var(--primary); border-color:var(--primary-2); color:#041423}
    .btn.success{background:var(--success); border-color:#0e9c5b; color:#031b12}
    .btn.warn{background:var(--warn); border-color:#e2b043; color:#2d2100}
    .btn.danger{background:var(--danger); border-color:#e14949; color:#2b0505}
    .btn.ghost{background:transparent}
    .icon-btn{
      width:var(--tap-min); height:var(--tap-min);
      display:inline-grid; place-items:center;
      border-radius:12px;
    }
    .sticky-footer{
      position:fixed; inset:auto 0 0 0; z-index:60;
      background:linear-gradient(to top, rgba(22,24,29,.98), rgba(25, 30, 41, 0.96) 60%, rgba(29, 34, 47, 0.92));
      backdrop-filter:saturate(1.2) blur(8px);
      padding:10px 16px calc(16px + env(safe-area-inset-bottom));
      border-top:1px solid var(--border);
    }
    .footer-grid{
      display:grid; gap:10px;
      grid-template-columns: repeat(12, 1fr);
      max-width:1100px;margin:0 auto;
    }
    .footer-grid .btn{min-width:100%}
    .footer-grid .span-2{grid-column:span 2}
    .footer-grid .span-3{grid-column:span 3}
    .footer-grid .span-4{grid-column:span 4}
    @media (max-width:1100px){
      .footer-grid .span-2,.footer-grid .span-3,.footer-grid .span-4{grid-column:span 6}
    }
    @media (max-width:520px){
      .footer-grid .span-2,.footer-grid .span-3,.footer-grid .span-4{grid-column:span 12}
    }

    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      background:var(--chip); border:1px solid var(--border);
      border-radius:999px; padding:8px 12px; min-height:var(--tap-min);
      display:inline-flex; align-items:center; gap:8px; color:var(--text);
    }
    .chip .x{background:transparent; border:none; color:var(--text-dim); cursor:pointer; font-size:18px; line-height:1; padding:0; width:24px; height:24px}
    .chip-input{
      display:flex; align-items:center; flex-wrap:wrap; gap:8px; background:var(--input); border:1px solid var(--border);
      border-radius:10px; padding:8px; min-height:var(--tap-min);
    }
    .chip-input input{
      border:none;background:transparent; min-height:32px; padding:8px;
      flex:1; outline:none;
    }

    .pills{display:flex; gap:8px; flex-wrap:wrap}
    .pill{
      border:1px solid var(--border); background:var(--chip); color:var(--text); border-radius:999px; padding:10px 14px;
      cursor:pointer; user-select:none; min-height:var(--tap-min); display:inline-flex; align-items:center; font-weight:700
    }
    .pill[aria-pressed="true"]{outline:4px solid rgba(154,209,255,.6); border-color:var(--focus); box-shadow:0 0 0 1px var(--focus)}
    .pill.completed{background:rgba(31,198,122,.16); border-color:rgba(31,198,122,.55)}
    .pill.nolaunch{background:rgba(255,93,93,.16); border-color:rgba(255,93,93,.55)}
    .pill.abort{background:rgba(255,200,87,.16); border-color:rgba(255,200,87,.55)}

    .hidden{display:none !important}
    .error{color:#ff9b9b; font-size:12px; margin-top:6px}
    .help{color:var(--text-dim); font-size:12px}

    details.group{background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); margin-top:12px; overflow:hidden}
    details.group > summary{
      list-style:none; cursor:pointer; padding:14px; background:linear-gradient(180deg, rgba(255,255,255,.02), transparent);
      display:flex; align-items:center; justify-content:space-between; gap:10px
    }
    details.group[open] > summary{border-bottom:1px solid var(--border)}
    summary::-webkit-details-marker{display:none}
    .group-title{font-weight:800}
    .metrics{display:flex;gap:10px;flex-wrap:wrap;padding:10px 14px;background:#12141a}
    .metric{
      background:var(--muted); border:1px solid var(--border); border-radius:12px; padding:8px 10px; font-size:13px; color:var(--text-dim)
    }
    .rows{display:grid; gap:8px; padding:12px}
    .rowcard{
      display:grid; gap:8px; grid-template-columns: 50px 78px 100px 96px 1fr 120px 1fr 44px;
      background:#13161c; border:1px solid var(--border); border-radius:12px; padding:10px; align-items:center
    }
    @media (max-width:1000px){
      .rowcard{grid-template-columns:1fr 1fr; grid-auto-rows:auto}
    }
    .status-dot{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:8px}
    .dot-success{background:var(--success)}
    .dot-warn{background:var(--warn)}
    .dot-danger{background:var(--danger)}

    .menu{
      position:relative
    }
    .menu-btn{background:var(--muted);border:1px solid var(--border); border-radius:10px; width:36px;height:36px; display:grid; place-items:center; cursor:pointer}
    .menu-list{
      position:absolute; right:0; top:44px; background:#0f1217; border:1px solid var(--border); border-radius:12px; min-width:160px; z-index:10; box-shadow:var(--shadow);
      display:none
    }
    .menu[open] .menu-list{display:block}
    .menu-item{display:block;width:100%; text-align:left; padding:12px 14px; background:transparent; border:0; color:var(--text); cursor:pointer}
    .menu-item:hover{background:#171b23}

    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:80; padding:16px
    }
    .modal{background:var(--panel); border:1px solid var(--border); border-radius:var(--radius-lg); width:min(820px, 100%); max-height:90vh; overflow:auto; padding:16px}
    .modal-backdrop.open{display:flex}

    .toast{
      position:fixed; left:50%; bottom:92px; transform:translateX(-50%);
      background:#0f131a; color:var(--text); border:1px solid var(--border); border-radius:999px; padding:12px 16px; z-index:100;
      box-shadow:var(--shadow); display:none
    }
    .toast.show{display:block; animation:fade .2s ease}
    @keyframes fade{from{opacity:0; transform:translateX(-50%) translateY(6px)} to{opacity:1; transform:translateX(-50%) translateY(0)}}

    .toolbar{display:flex; gap:10px; align-items:center; justify-content:space-between}
    .subtitle{color:var(--text-dim)}
    .sep{height:1px;background:var(--border);margin:10px 0}
    .config{
      position:fixed; right:16px; top:54px; width:min(420px, 92vw); background:var(--panel); border:1px solid var(--border);
      border-radius:16px; padding:14px; z-index:70; display:none; box-shadow:var(--shadow)
    }
    .config.open{display:block}
    .switch{display:inline-flex; align-items:center; gap:8px}
    .switch input{width:auto; min-height:auto}
    .inline{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .actions-chips{display:flex; gap:8px; flex-wrap:wrap}
    .action-chip{
      border:1px solid var(--border); border-radius:999px; padding:8px 12px; background:var(--chip); cursor:pointer; user-select:none
    }
    .action-chip[aria-pressed="true"]{outline:3px solid rgba(154,209,255,.25); border-color:var(--focus)}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; background:#0d0f14; border:1px solid var(--border); padding:2px 6px; border-radius:6px; color:var(--text-dim)}
    .sr-only{position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden}
  </style>
</head>
<body>
  <div class="topbar" role="banner">
    <div class="toolbar">
      <div class="row">
        <button id="configBtn" class="btn icon-btn" aria-haspopup="dialog" aria-expanded="false" aria-controls="configPanel" title="Open settings">⚙️</button>
        <h1><span id="appTitle">Drone</span> Tracker V0.8.5</h1>
        <span class="badge" id="queuedBadge" aria-live="polite" title="Queued webhook payloads" style="display:none">Queued sends: <b id="queuedCount">0</b></span>
      </div>
      <div class="subtitle">Per show run data entry. Offline first. Local only until you export or submit.</div>
    </div>
  </div>

  <div class="container" role="main">
    <!-- Show header -->
    <section class="panel" aria-labelledby="showHeaderTitle">
      <h2 id="showHeaderTitle">Show header</h2>
      <div class="grid">
        <div class="col-3">
          <label for="showDate">Date</label>
          <input id="showDate" type="date" autocomplete="off" required />
          <div class="error" id="errDate" hidden>Required</div>
        </div>
        <div class="col-3">
          <label for="showTime">Show start time</label>
          <input id="showTime" type="time" inputmode="numeric" required />
          <div class="error" id="errTime" hidden>Required</div>
        </div>
        <div class="col-6">
          <label for="showLabel">Show label or number</label>
          <input id="showLabel" type="text" placeholder="e.g., 7pm Main" />
        </div>

        <div class="col-6">
          <label>Crew on duty <span class="help">(press Enter to add name)</span></label>
          <div id="crewInput" class="chip-input" aria-label="Crew on duty input"></div>
        </div>

        <div class="col-3">
          <label for="leadPilot">Lead Pilot</label>
          <select id="leadPilot">
            <option value="">Select</option>
          </select>
        </div>
        <div class="col-3">
          <label for="monkeyLead">Monkey Lead</label>
          <select id="monkeyLead">
            <option value="">Select</option>
          </select>
        </div>


        <div class="col-12">
          <label for="showNotes">Notes for the show</label>
          <textarea id="showNotes" placeholder="High-level notes"></textarea>
        </div>
      </div>
    </section>

    <!-- Entry form -->
    <section class="panel" aria-labelledby="entryTitle">
      <h2 id="entryTitle">Entry form</h2>
      <div class="grid" id="entryForm">
        <div class="col-2">
          <label for="unitId"><span id="unitLabel">Monkey</span> ID</label>
          <select id="unitId" aria-required="true"></select>
          <div class="error" id="errUnit" hidden>Required</div>
        </div>

        <div class="col-2">
          <label for="planned">Planned to fly</label>
          <select id="planned">
            <option value="">Select</option>
            <option>Yes</option>
            <option>No</option>
          </select>
          <div class="error" id="errPlanned" hidden>Required</div>
        </div>

        <div class="col-2">
          <label for="launched">Launched</label>
          <select id="launched">
            <option value="">Select</option>
            <option>Yes</option>
            <option>No</option>
          </select>
          <div class="error" id="errLaunched" hidden>Required</div>
        </div>


        <div class="col-4">
          <label>Status</label>
          <div class="pills" role="group" aria-label="Status">
            <button type="button" class="pill completed" id="stCompleted" data-status="Completed" aria-pressed="false"><span class="status-dot dot-success"></span>Completed</button>
            <button type="button" class="pill nolaunch" id="stNoLaunch" data-status="No-launch" aria-pressed="false"><span class="status-dot dot-danger"></span>No-launch</button>
            <button type="button" class="pill abort" id="stAbort" data-status="Abort" aria-pressed="false"><span class="status-dot dot-warn"></span>Abort</button>
          </div>
          <div class="error" id="errStatus" hidden>Required</div>
        </div>

        <div class="col-4 issue-block hidden">
          <label for="primaryIssue">Primary issue</label>
          <select id="primaryIssue"></select>
          <div class="error" id="errPrimary" hidden>Required</div>
        </div>
        <div class="col-4 issue-block hidden">
          <label for="subIssue">Sub-issue</label>
          <select id="subIssue"></select>
        </div>
        <div class="col-4 issue-block hidden" id="otherDetailWrap">
          <label for="otherDetail">Other detail</label>
          <input id="otherDetail" type="text" placeholder="Short detail" />
          <div class="error" id="errOther" hidden>Required</div>
        </div>

        <div class="col-4 issue-block hidden">
          <label for="severity">Severity</label>
          <select id="severity">
            <option value="">Select</option>
            <option>Critical show stop</option>
            <option>Major visible</option>
            <option>Minor contained</option>
          </select>
          <div class="error" id="errSeverity" hidden>Required</div>
        </div>

        <div class="col-4 issue-block hidden">
          <label for="rootCause">Root cause draft</label>
          <select id="rootCause">
            <option value="">Select</option>
            <option>Hardware</option>
            <option>Software</option>
            <option>Ops</option>
            <option>Environment</option>
            <option>Unknown</option>
          </select>
        </div>

        <div class="col-12 issue-block hidden">
          <label>Actions taken</label>
          <div class="actions-chips" id="actionsChips" role="group" aria-label="Actions taken"></div>
        </div>

        <div class="col-3">
          <label for="operator">Operator</label>
          <select id="operator"></select>
        </div>
        <div class="col-3">
          <label for="batteryId">Battery ID</label>
          <input id="batteryId" type="text" inputmode="text" placeholder="e.g., B-12" />
        </div>
        <div class="col-3">
          <label for="delaySec">Launch delay seconds</label>
          <input id="delaySec" type="number" step="0.1" min="0" placeholder="0.0" />
          <div class="error" id="errDelay" hidden>Must be a non-negative number</div>
        </div>

        

        <div class="col-3">
          <label for="commandRx">Command received</label>
          <select id="commandRx">
            <option value="">Select</option>
            <option>Yes</option>
            <option>No</option>
          </select>
        </div>

        <div class="col-9">
          <label for="entryNotes">Notes</label>
          <input id="entryNotes" type="text" placeholder="Short note" />
        </div>
      </div>
    </section>

    <!-- Show groups render target -->
    <section id="groups"></section>
  </div>

  <!-- Sticky footer actions -->
  <div class="sticky-footer" role="contentinfo">
    <div class="footer-grid">
      <button id="newShow" class="btn span-2">New Show</button>
      <button id="dupShow" class="btn span-3">Duplicate Last Show</button>
      <button id="addLine" class="btn primary span-3">Add line</button>
      <button id="saveBtn" class="btn span-2">Save</button>
      <button id="exportCsv" class="btn span-2">Export CSV</button>
      <button id="exportJson" class="btn span-2">Export JSON</button>
      <button id="resetApp" class="btn danger span-2">Reset App</button>
      <button id="submitWebhook" class="btn success span-3">Submit to Webhook</button>
    </div>
  </div>

  <!-- Config panel -->
  <div id="configPanel" class="config" role="dialog" aria-modal="true" aria-labelledby="cfgTitle">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3 id="cfgTitle">Settings</h3>
      <button class="btn icon-btn" id="closeConfig" title="Close">✖️</button>
    </div>
    <div class="sep"></div>
    <div class="grid">
      <div class="col-12">
        <label>Unit label</label>
        <div class="inline" role="group" aria-label="Unit label">
          <label class="switch"><input type="radio" name="unitLabel" value="Drone" checked> Drone</label>
          <label class="switch"><input type="radio" name="unitLabel" value="Monkey"> Monkey</label>
        </div>
      </div>

      <div class="col-12">
        <label>Webhook</label>
        <div class="grid">
          <div class="col-12">
            <input id="whUrl" type="url" placeholder="Webhook URL" />
          </div>
          <div class="col-6">
            <input id="whHeaderName" type="text" placeholder="Secret header name (optional)" />
          </div>
          <div class="col-6">
            <input id="whSecret" type="text" placeholder="Secret value (optional)" />
          </div>
          <div class="col-12 inline">
            <button id="retryQueued" class="btn">Retry queued sends</button>
            <span class="help">Manual retries use exponential backoff per payload</span>
          </div>
        </div>
      </div>

      <div class="col-12">
        <label>Data</label>
        <div class="inline">
          <input id="importFile" type="file" accept="application/json" aria-label="Import JSON file">
          <button id="importBtn" class="btn">Import JSON</button>
          <button id="loadSample" class="btn">Load sample data</button>
          <button id="clearAll" class="btn danger">Clear all data</button>
        </div>
        <div class="help">Exports download to your device. All state saves to localStorage automatically.</div>
      </div>
    </div>
  </div>

  <!-- Modal for editing an entry -->
  <div class="modal-backdrop" id="editModal" role="dialog" aria-modal="true" aria-labelledby="editTitle">
    <div class="modal">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 id="editTitle">Edit entry</h3>
        <button class="btn icon-btn" id="closeEdit" title="Close">✖️</button>
      </div>
      <div class="sep"></div>
      <div id="editForm" class="grid"></div>
      <div class="sep"></div>
      <div class="row" style="justify-content:flex-end">
        <button id="saveEdit" class="btn primary">Save changes</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
(function(){
  const STORAGE_KEY = 'droneTracker_v1';
  function getDefaultUnits(){
    if(state.unitLabel === 'Monkey'){
      return Array.from({length: 12}, (_, i) => String(i+1));
    }
    return Array.from({length: 12}, (_, i) => 'D' + (i+1));
  }
  const ISSUE_MAP = {
    "Tracking lost": ["occlusion","calibration","marker loss","software","unknown"],
    "Failed to launch": ["mechanical","arming","safety","unknown"],
    "Command delay": ["network latency","controller queue","unknown"],
    "RF link": ["TX fault","RX fault","interference","antenna","unknown"],
    "Battery": ["low voltage","BMS fault","poor contact","swelling","unknown"],
    "Motor or prop": ["no spin","desync","damage","unknown"],
    "Sensor or IMU": ["bias","calibration","saturation","unknown"],
    "Software or show control": ["cue timing","state desync","crash","unknown"],
    "Pilot input": ["incorrect mode","early abort","missed cue","unknown"],
    "Other": []
  };
  const ACTIONS = ["Reboot","Swap battery","Swap drone","Retry launch","Abort segment","Logged only"];
  const DEFAULT_CREW = ["Alex","Nick","John Henery","James","Robert","Nazar"];
  const PRIMARY_ISSUES = Object.keys(ISSUE_MAP);
  const STATUS = ["Completed","No-launch","Abort"];

  let state = loadState();
  let currentShow = ensureCurrentShow();
  let editingEntryRef = null; // {showId, entryId}

  // Elements
  const appTitle = el('appTitle');
  const unitLabelEl = el('unitLabel');
  const queuedBadge = el('queuedBadge'), queuedCount = el('queuedCount');

  const showDate = el('showDate'), showTime = el('showTime'), showLabel = el('showLabel');
  const showNotes = el('showNotes');
  const crewInput = el('crewInput');
  const leadPilotSelect = el('leadPilot'), monkeyLeadSelect = el('monkeyLead');

  const unitId = el('unitId'), planned = el('planned'), launched = el('launched');
  const stCompleted = el('stCompleted'), stNoLaunch = el('stNoLaunch'), stAbort = el('stAbort');
  const primaryIssue = el('primaryIssue'), subIssue = el('subIssue'), otherDetail = el('otherDetail'), otherDetailWrap = el('otherDetailWrap');
  const severity = el('severity'), rootCause = el('rootCause'), actionsChips = el('actionsChips');
  const operator = el('operator'), batteryId = el('batteryId'), delaySec = el('delaySec'), commandRx = el('commandRx'), entryNotes = el('entryNotes');
  const issueBlocks = qsa('.issue-block');

  const groupsContainer = el('groups');

  // Footer buttons
  el('newShow').addEventListener('click', onNewShow);
  el('dupShow').addEventListener('click', onDuplicateLast);
  el('addLine').addEventListener('click', onAddLine);
  el('saveBtn').addEventListener('click', ()=>{ saveState(true); toast('Saved'); });
  el('exportCsv').addEventListener('click', onExportCsv);
  el('exportJson').addEventListener('click', onExportJson);
  el('resetApp').addEventListener('click', clearAllData);
  el('submitWebhook').addEventListener('click', onSubmitWebhook);

  // Config panel
  const cfgBtn = el('configBtn'), cfgPanel = el('configPanel'), closeCfg = el('closeConfig');
  cfgBtn.addEventListener('click', ()=>{ toggleConfig(true) });
  closeCfg.addEventListener('click', ()=>{ toggleConfig(false) });
  document.addEventListener('keydown', e=>{
    if(e.key==='Escape'){ toggleConfig(false); closeEditModal(); }
  });

  qsa('input[name="unitLabel"]').forEach(r=>{
    r.checked = (state.unitLabel === r.value);
    r.addEventListener('change', ()=>{
      state.unitLabel = r.value; onUnitLabelChange();
      saveState();
    });
  });
  const whUrl = el('whUrl'), whHeaderName = el('whHeaderName'), whSecret = el('whSecret');
  whUrl.value = state.webhook.url || '';
  whHeaderName.value = state.webhook.headerName || '';
  whSecret.value = state.webhook.secret || '';
  whUrl.addEventListener('change', ()=>{ state.webhook.url = whUrl.value.trim(); saveState(); });
  whHeaderName.addEventListener('change', ()=>{ state.webhook.headerName = whHeaderName.value.trim(); saveState(); });
  whSecret.addEventListener('change', ()=>{ state.webhook.secret = whSecret.value; saveState(); });

  el('retryQueued').addEventListener('click', retryQueued);
  el('importBtn').addEventListener('click', onImportJson);
  el('loadSample').addEventListener('click', loadSampleData);
  el('clearAll').addEventListener('click', clearAllData);

  // Modal
  el('closeEdit').addEventListener('click', closeEditModal);
  el('saveEdit').addEventListener('click', saveEditEntry);

  // Header bindings
  bindHeaderInputs();

  // Entry form init
  populateUnitOptions();
  populateIssues();
  renderActionsChips(actionsChips, []);
  renderOperatorOptions();

  // Status pills
  [stCompleted, stNoLaunch, stAbort].forEach(btn=>{
    btn.addEventListener('click', ()=>{
      setStatus(btn.dataset.status);
      updateIssueVisibility();
    });
  });

  // Planned and Launched logic
  planned.addEventListener('change', onPlanLaunchChange);
  launched.addEventListener('change', onPlanLaunchChange);

  // Primary issue change
  primaryIssue.addEventListener('change', ()=>{
    populateSubIssues(primaryIssue.value);
    updateIssueVisibility();
  });

  // Other detail input show/hide
  function updateIssueVisibility(){
    const st = getStatus();
    const showIssues = st && st !== 'Completed';
    issueBlocks.forEach(b=> b.classList.toggle('hidden', !showIssues));
    const isOther = primaryIssue.value === 'Other';
    otherDetailWrap.classList.toggle('hidden', !showIssues || !isOther);
  }

  // Crew chip input
  initCrewChipInput(crewInput, currentShow.crew || [], names=>{
    currentShow.crew = names;
    renderOperatorOptions();
    saveState();
  });

  // Initial header values
  fillHeader(currentShow);

  // Render groups
  renderGroups();

  // Show queued badge
  updateQueuedBadge();

  // Utility: DOM
  function el(id){return document.getElementById(id)}
  function qs(s, root=document){return root.querySelector(s)}
  function qsa(s, root=document){return Array.from(root.querySelectorAll(s))}

  // State persistence
  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw){
        const parsed = JSON.parse(raw);
        // ensure fields
        parsed.unitLabel = parsed.unitLabel || 'Drone';
        parsed.webhook = parsed.webhook || {url:'', headerName:'', secret:''};
        parsed.queuedSends = parsed.queuedSends || [];
        parsed.shows = Array.isArray(parsed.shows) ? parsed.shows.map(normalizeShow) : [];
        return parsed;
      }
    }catch(e){}
    // default
    return {
      unitLabel:'Drone',
      shows:[],
      currentShowId:null,
      webhook:{url:'', headerName:'', secret:''},
      queuedSends:[]
    };
  }
  function saveState(force){
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      if(force){} // toast handled by caller
    }catch(e){
      toast('Save failed: localStorage quota?', true);
    }
  }

  function onUnitLabelChange(){
    appTitle.textContent = state.unitLabel;
    unitLabelEl.textContent = state.unitLabel;
    // Update group headings and unit label texts
    populateUnitOptions();
    renderGroups();
  }

  function ensureCurrentShow(){
    if(state.currentShowId){
      const s = state.shows.find(x=>x.id===state.currentShowId);
      if(s){
        s.crew = Array.isArray(s.crew) ? s.crew : [];
        s.leadPilot = typeof s.leadPilot === 'string' ? s.leadPilot : '';
        s.monkeyLead = typeof s.monkeyLead === 'string' ? s.monkeyLead : '';
        return s;
      }
    }
    const now = new Date();
    const dateStr = fmtDateInput(now);
    const timeStr = pad2(now.getHours())+':'+pad2(now.getMinutes());
    const s = {
      id: genId('show'),
      date: dateStr,
      time: '',
      label: '',
      crew: [],
      leadPilot: '',
      monkeyLead: '',
      weather:{},
      notes:'',
      entries:[]
    };
    state.shows.unshift(s);
    state.currentShowId = s.id;
    saveState();
    return s;
  }
  function getCurrentShow(){
    return state.shows.find(x=>x.id===state.currentShowId);
  }

  function bindHeaderInputs(){
    showDate.addEventListener('change', ()=>{
      currentShow.date = showDate.value;
      saveState(); renderGroups();
    });
    showTime.addEventListener('change', ()=>{
      currentShow.time = showTime.value;
      saveState(); renderGroups();
    });
    showLabel.addEventListener('input', ()=>{
      currentShow.label = showLabel.value;
      saveState(); renderGroups();
    });
    showNotes.addEventListener('input', ()=>{ currentShow.notes = showNotes.value; saveState() });
    leadPilotSelect.addEventListener('change', ()=>{
      currentShow.leadPilot = leadPilotSelect.value;
      saveState();
    });
    monkeyLeadSelect.addEventListener('change', ()=>{
      currentShow.monkeyLead = monkeyLeadSelect.value;
      saveState();
    });
  }
  function fillHeader(s){
    showDate.value = s.date || '';
    showTime.value = s.time || '';
    showLabel.value = s.label || '';
    showNotes.value = s.notes || '';
    leadPilotSelect.value = s.leadPilot || '';
    monkeyLeadSelect.value = s.monkeyLead || '';
    // crew chips handled by chip input init already
    renderLeadRoleOptions(s);
  }

  function populateUnitOptions(){
    unitId.innerHTML = `<option value="">Select</option>` + getDefaultUnits().map(u=>`<option>${u}</option>`).join('');
  }

  function populateIssues(){
    primaryIssue.innerHTML = `<option value="">Select</option>` + PRIMARY_ISSUES.map(i=>`<option>${i}</option>`).join('');
    populateSubIssues('');
  }
  function populateSubIssues(primary){
    const arr = ISSUE_MAP[primary] || [];
    subIssue.innerHTML = `<option value="">${arr.length? 'Select' : 'N/A'}</option>` + arr.map(s=>`<option>${s}</option>`).join('');
  }

  function renderActionsChips(container, selected){
    container.innerHTML = '';
    ACTIONS.forEach(a=>{
      const b = document.createElement('button');
      b.type='button'; b.className='action-chip'; b.textContent = a; b.setAttribute('aria-pressed', selected.includes(a) ? 'true':'false');
      b.addEventListener('click', ()=>{ b.setAttribute('aria-pressed', b.getAttribute('aria-pressed')==='true' ? 'false':'true'); });
      container.appendChild(b);
    });
  }
  function getSelectedActions(container){
    return qsa('.action-chip', container).filter(b=>b.getAttribute('aria-pressed')==='true').map(b=>b.textContent);
  }

  function renderOperatorOptions(){
    const allOptions = getCrewOptionList(currentShow);
    operator.innerHTML = `<option value="">Select</option>` + allOptions.map(n=>`<option>${n}</option>`).join('');
    renderLeadRoleOptions(currentShow, allOptions);
  }

  function getCrewOptionList(show){
    const crew = Array.isArray(show?.crew) ? show.crew.filter(Boolean) : [];
    const extras = [show?.leadPilot, show?.monkeyLead].filter(Boolean);
    return [...new Set([...crew, ...extras, ...DEFAULT_CREW])];
  }

  function renderLeadRoleOptions(show, options){
    if(!leadPilotSelect || !monkeyLeadSelect) return;
    const targetShow = show || currentShow || {leadPilot:'', monkeyLead:'', crew:[]};
    const opts = (options || getCrewOptionList(targetShow));
    const html = `<option value="">Select</option>` + opts.map(n=>`<option>${n}</option>`).join('');
    leadPilotSelect.innerHTML = html;
    monkeyLeadSelect.innerHTML = html;
    leadPilotSelect.value = targetShow.leadPilot || '';
    monkeyLeadSelect.value = targetShow.monkeyLead || '';
  }

  function setStatus(s){
    [stCompleted, stNoLaunch, stAbort].forEach(b=>b.setAttribute('aria-pressed', b.dataset.status===s ? 'true':'false'));
  }
  function getStatus(){
    const btn = [stCompleted, stNoLaunch, stAbort].find(b=>b.getAttribute('aria-pressed')==='true');
    return btn ? btn.dataset.status : '';
  }

  function onPlanLaunchChange(){
    const p = planned.value, l = launched.value;
    if(p === 'No'){
      // Only No-launch allowed
      setStatus('No-launch');
    }else{
      if(l === 'No'){
        setStatus('No-launch');
      }else if(l === 'Yes'){
        // Completed or Abort allowed, default to Completed if none
        const s = getStatus();
        if(s === '' || s === 'No-launch'){ setStatus('Completed'); }
      }
    }
    updateIssueVisibility();
  }

  // Add Line
  function onAddLine(){
    currentShow = getCurrentShow(); // refresh ref
    clearErrors();

    // Validate show header minimal
    let ok = true;
    if(!currentShow.date){ showError('errDate'); ok = false; }
    if(!currentShow.time){ showError('errTime'); ok = false; }

    // Validate entry
    if(!unitId.value){ showError('errUnit'); ok = false; }
    if(!planned.value){ showError('errPlanned'); ok = false; }
    if(!launched.value){ showError('errLaunched'); ok = false; }
    const st = getStatus();
    if(!st){ showError('errStatus'); ok = false; }

    // Logic constraints
    if(planned.value === 'No' && st !== 'No-launch'){ showError('errStatus'); toast('If Planned is No, Status must be No-launch', true); ok=false; }
    if(launched.value === 'No' && st !== 'No-launch'){ showError('errStatus'); toast('If Launched is No, Status must be No-launch', true); ok=false; }
    if(launched.value === 'Yes' && st === 'No-launch'){ showError('errStatus'); toast('If Launched is Yes, Status cannot be No-launch', true); ok=false; }

    // Issues required when not Completed
    if(st !== 'Completed'){
      if(!primaryIssue.value){ showError('errPrimary'); ok=false; }
      if(!severity.value){ showError('errSeverity'); ok=false; }
      if(primaryIssue.value === 'Other' && !otherDetail.value.trim()){ showError('errOther'); ok=false; }
    }

    // Delay validation
    if(delaySec.value){
      const v = Number(delaySec.value);
      if(!Number.isFinite(v) || v < 0){ showError('errDelay'); ok=false; }
    }

    if(!ok){ return }

    const entry = {
      id: genId('entry'),
      ts: Date.now(),
      unitId: unitId.value,
      planned: planned.value,
      launched: launched.value,
      status: st,
      primaryIssue: st==='Completed' ? '' : primaryIssue.value,
      subIssue: st==='Completed' ? '' : (subIssue.value || ''),
      otherDetail: st==='Completed' ? '' : (primaryIssue.value==='Other' ? otherDetail.value.trim() : ''),
      severity: st==='Completed' ? '' : (severity.value || ''),
      rootCause: st==='Completed' ? '' : (rootCause.value || ''),
      actions: st==='Completed' ? [] : getSelectedActions(actionsChips),
      operator: operator.value || '',
      batteryId: batteryId.value.trim(),
      delaySec: delaySec.value ? Number(delaySec.value) : null,
      
      commandRx: commandRx.value || '',
      notes: entryNotes.value.trim()
    };

    currentShow.entries.push(entry);
    saveState();
    clearEntryForm();
    renderGroups();
    toast('Line added');
  }

  function clearEntryForm(){
    unitId.value = '';
    planned.value = '';
    launched.value = '';
    setStatus('');
    primaryIssue.value = '';
    subIssue.innerHTML = `<option value="">N/A</option>`;
    otherDetail.value = '';
    severity.value = '';
    rootCause.value = '';
    renderActionsChips(actionsChips, []);
    operator.value = '';
    batteryId.value = '';
    delaySec.value = '';
    
    commandRx.value = '';
    entryNotes.value = '';
    updateIssueVisibility();
  }

  // Groups rendering
  function renderGroups(){
    // sort newest show first by datetime
    state.shows.sort((a,b)=> compareShowDateTimeDesc(a,b));
    groupsContainer.innerHTML = '';
    state.shows.forEach(show=>{
      const open = (show.id === state.currentShowId);
      const group = document.createElement('details');
      group.className = 'group';
      if(open) group.open = true;
      const title = groupTitle(show);

      const summary = document.createElement('summary');
      summary.innerHTML = `<div class="group-title">${title}</div><div class="badge">${show.entries.length} entries</div>`;
      summary.addEventListener('click', ()=>{
        // Switch current show when opened
        setTimeout(()=>{
          if(group.open){
            state.currentShowId = show.id; currentShow = show; saveState();
            fillHeader(show);
            // update crew chips
            initCrewChipInput(crewInput, show.crew || [], names=>{
              show.crew = names; renderOperatorOptions(); saveState();
            });
            renderOperatorOptions();
            // place entry form above this group by scroll
          }
        }, 0);
      });

      const metrics = computeMetrics(show);
      const metricsDiv = document.createElement('div');
      metricsDiv.className = 'metrics';
      metricsDiv.innerHTML = `
        <div class="metric">Launch success: <b>${metrics.successRate}%</b> of planned</div>
        <div class="metric">Completed: <b>${metrics.countCompleted}</b></div>
        <div class="metric">No-launch: <b>${metrics.countNoLaunch}</b></div>
        <div class="metric">Abort: <b>${metrics.countAbort}</b></div>
        <div class="metric">Avg delay: <b>${metrics.avgDelay}</b> s</div>
        <div class="metric">Top issues: <b>${metrics.topIssues.join(', ') || 'n/a'}</b></div>
      `;

      const rows = document.createElement('div');
      rows.className = 'rows';
      
      // Add header row
      const headerRow = document.createElement('div');
      headerRow.className = 'rowcard';
      headerRow.style.background = '#1a1d26';
      headerRow.style.fontWeight = '700';
      headerRow.style.color = 'var(--text-dim)';
      headerRow.style.borderBottom = '2px solid var(--border)';
      const idHeader = state.unitLabel === 'Monkey' ? 'M#' : 'D#';
      headerRow.innerHTML = `
        <div><b>${idHeader}</b></div>
        <div><b>Planned</b></div>
        <div><b>Launched</b></div>
        <div><b>Status</b></div>
        <div><b>Issue</b></div>
        <div><b>Operator</b></div>
        <div><b>Notes</b></div>
        <div></div>
      `;
      rows.appendChild(headerRow);
      
      show.entries.slice().sort((a,b)=> b.ts - a.ts).forEach(e=>{
        rows.appendChild(renderRow(show, e));
      });

      group.appendChild(summary);
      group.appendChild(metricsDiv);
      group.appendChild(rows);
      groupsContainer.appendChild(group);
    });
  }

  function groupTitle(show){
    const d = formatDateUS(show.date) || 'MM-DD-YYYY';
    const t = formatTime12Hour(show.time) || 'HH:mm AM';
    const label = show.label ? ` • ${escapeHtml(show.label)}` : '';
    return `${d} • ${t}${label}`;
  }

  function renderRow(show, e){
    const rc = document.createElement('div');
    rc.className = 'rowcard';
    const colorDot = e.status==='Completed' ? 'dot-success' : e.status==='Abort' ? 'dot-warn' : 'dot-danger';
    const issueTxt = e.status==='Completed' ? '' : [e.primaryIssue, e.subIssue || e.otherDetail].filter(Boolean).join(' / ');
    const actionsTxt = (e.actions||[]).join(', ');
    rc.innerHTML = `
      <div><b>${escapeHtml(e.unitId)}</b></div>
      <div>${escapeHtml(e.planned || '')}</div>
      <div>${escapeHtml(e.launched || '')}</div>
      <div><span class="status-dot ${colorDot}"></span>${escapeHtml(e.status || '')}</div>
      <div>${escapeHtml(issueTxt)}</div>
      <div>${escapeHtml(e.operator || '')}</div>
      <div>${escapeHtml(e.notes || '')}</div>
      <div class="menu" data-menu>
        <button class="menu-btn" title="Row menu" aria-haspopup="true" aria-expanded="false">⋯</button>
        <div class="menu-list" role="menu">
          <button class="menu-item" role="menuitem" data-edit>Edit</button>
          <button class="menu-item" role="menuitem" data-delete>Delete</button>
        </div>
      </div>
    `;
    const menu = qs('[data-menu]', rc);
    const btn = qs('.menu-btn', menu);
    btn.addEventListener('click', (e2)=>{
      e2.stopPropagation();
      const open = menu.hasAttribute('open');
      closeAllMenus();
      if(!open) menu.setAttribute('open','');
      btn.setAttribute('aria-expanded', String(!open));
      document.addEventListener('click', closeAllMenus, {once:true});
    });
    qs('[data-edit]', rc).addEventListener('click', ()=>{
      menu.removeAttribute('open');
      openEditModal(show.id, e.id);
    });
    qs('[data-delete]', rc).addEventListener('click', ()=>{
      menu.removeAttribute('open');
      if(confirm('Delete this entry?')){
        const idx = show.entries.findIndex(x=>x.id===e.id);
        if(idx>=0){ show.entries.splice(idx,1); saveState(); renderGroups(); toast('Entry deleted'); }
      }
    });
    return rc;
  }
  function closeAllMenus(){ qsa('[data-menu]').forEach(m=>m.removeAttribute('open')) }

  function computeMetrics(show){
    const plannedYes = show.entries.filter(e=>e.planned==='Yes').length;
    const completed = show.entries.filter(e=>e.status==='Completed').length;
    const noLaunch = show.entries.filter(e=>e.status==='No-launch').length;
    const abort = show.entries.filter(e=>e.status==='Abort').length;
    const delays = show.entries.map(e=>e.delaySec).filter(v=>typeof v==='number');
    const avgDelay = delays.length ? (delays.reduce((a,b)=>a+b,0)/delays.length).toFixed(2) : '0.00';
    const issues = {};
    show.entries.forEach(e=>{
      if(e.status!=='Completed' && e.primaryIssue){
        issues[e.primaryIssue] = (issues[e.primaryIssue]||0)+1;
      }
    });
    const topIssues = Object.entries(issues).sort((a,b)=>b[1]-a[1]).slice(0,3).map(x=>x[0]);
    const rate = plannedYes ? Math.round((completed/plannedYes)*100) : 0;
    return {successRate: rate, countCompleted: completed, countNoLaunch: noLaunch, countAbort: abort, avgDelay, topIssues};
  }

  // CSV and JSON
  function onExportCsv(){
    const show = getCurrentShow();
    if(!show){ toast('No current show', true); return }
    const headers = [
      'showDate','showTime','showLabel','crew','leadPilot','monkeyLead','showNotes',
      'entryId','timestamp','unitId','planned','launched','status',
      'primaryIssue','subIssue','otherDetail','severity','rootCause','actions',
      'operator','batteryId','delaySec','commandReceived','entryNotes'
    ];
    const crewStr = (show.crew||[]).join('; ');
    const base = [
      formatDateUS(show.date),
      formatTime12Hour(show.time),
      show.label,
      crewStr,
      show.leadPilot || '',
      show.monkeyLead || '',
      show.notes || ''
    ];
    const rows = show.entries.map(e=>{
      return [
        ...base,
        e.id, new Date(e.ts).toISOString(),
        e.unitId, e.planned, e.launched, e.status,
        e.primaryIssue, e.subIssue, e.otherDetail, e.severity, e.rootCause, (e.actions||[]).join('|'),
        e.operator, e.batteryId, (e.delaySec!=null? String(e.delaySec):''), e.commandRx, e.notes
      ];
    });
    const csvRows = [headers, ...rows].map(r=>r.map(csvEscape).join(','));
    const csv = csvRows.join('\r\n') + '\r\n';
    downloadFile(csv, `show-${show.date || 'date'}-${show.time || 'time'}.csv`, 'text/csv');
    toast('CSV exported');
  }
  function onExportJson(){
    const payload = {unitLabel: state.unitLabel, shows: state.shows};
    const json = JSON.stringify(payload, null, 2);
    downloadFile(json, 'drone-tracker.json', 'application/json');
    toast('JSON exported');
  }
  function onImportJson(){
    const file = el('importFile').files && el('importFile').files[0];
    if(!file){ toast('Choose a JSON file', true); return }
    const reader = new FileReader();
    reader.onload = () =>{
      try{
        const data = JSON.parse(reader.result);
        if(!data || !Array.isArray(data.shows || data)) throw new Error('Invalid format');
        const shows = Array.isArray(data) ? data : data.shows;
        state.shows = shows.map(normalizeShow);
        state.unitLabel = data.unitLabel || state.unitLabel || 'Drone';
        state.currentShowId = state.shows[0]?.id || null;
        saveState();
        onUnitLabelChange();
        currentShow = ensureCurrentShow();
        fillHeader(currentShow);
        initCrewChipInput(crewInput, currentShow.crew || [], names=>{ currentShow.crew=names; renderOperatorOptions(); saveState(); });
        renderOperatorOptions();
        renderGroups();
        toast('Imported');
      }catch(err){
        toast('Import failed', true);
      }
    };
    reader.readAsText(file);
  }
  function normalizeShow(s){
    return {
      id: s.id || genId('show'),
      date: s.date || '',
      time: s.time || '',
      label: s.label || '',
      crew: Array.isArray(s.crew) ? s.crew : [],
      leadPilot: typeof s.leadPilot === 'string' ? s.leadPilot : '',
      monkeyLead: typeof s.monkeyLead === 'string' ? s.monkeyLead : '',
      weather: s.weather || {wind:'', temp:''},
      notes: s.notes || '',
      entries: Array.isArray(s.entries) ? s.entries.map(e=>({
        id: e.id || genId('entry'),
        ts: e.ts || Date.now(),
        unitId: e.unitId || '',
        planned: e.planned || '',
        launched: e.launched || '',
        status: e.status || '',
        primaryIssue: e.primaryIssue || '',
        subIssue: e.subIssue || '',
        otherDetail: e.otherDetail || '',
        severity: e.severity || '',
        rootCause: e.rootCause || '',
        actions: Array.isArray(e.actions) ? e.actions : [],
        operator: e.operator || '',
        batteryId: e.batteryId || '',
        delaySec: typeof e.delaySec==='number' ? e.delaySec : (e.delaySec ? Number(e.delaySec) : null),
        
        commandRx: e.commandRx || '',
        notes: e.notes || ''
      })) : []
    };
  }

  // New show and duplicate
  function onNewShow(){
    const now = new Date();
    const s = {
      id: genId('show'),
      date: fmtDateInput(now),
      time: '',
      label: '',
      crew: [],
      leadPilot: '',
      monkeyLead: '',
      weather:{},
      notes:'',
      entries:[]
    };
    state.shows.unshift(s);
    state.currentShowId = s.id; currentShow = s;
    saveState();
    fillHeader(s);
    initCrewChipInput(crewInput, [], names=>{ s.crew=names; renderOperatorOptions(); saveState(); });
    renderOperatorOptions();
    // Reset any lingering errors and entry form fields when starting a new show
    clearErrors();
    clearEntryForm();
    renderGroups();
    toast('New show created');
  }
  function onDuplicateLast(){
    if(!state.shows.length){ onNewShow(); return }
    const last = state.shows[0];
    const s = {
      id: genId('show'),
      date: last.date,
      time: last.time,
      label: last.label,
      crew: [...(last.crew||[])],
      leadPilot: last.leadPilot || '',
      monkeyLead: last.monkeyLead || '',
      weather:{...last.weather},
      notes: last.notes || '',
      entries:[]
    };
    state.shows.unshift(s);
    state.currentShowId = s.id; currentShow = s;
    saveState();
    fillHeader(s);
    initCrewChipInput(crewInput, s.crew, names=>{ s.crew=names; renderOperatorOptions(); saveState(); });
    renderOperatorOptions();
    // Reset any lingering errors and entry form fields when duplicating a show
    clearErrors();
    clearEntryForm();
    renderGroups();
    toast('Show duplicated');
  }

  // Webhook submit and queue
  async function onSubmitWebhook(){
    const show = getCurrentShow();
    if(!show){ toast('No current show', true); return }
    if(!state.webhook.url){ toast('Set Webhook URL in Settings', true); toggleConfig(true); return }
    const payload = { unitLabel: state.unitLabel, show };
    try{
      await sendWebhook(payload);
      toast('Submitted to webhook');
    }catch(err){
      // queue
      state.queuedSends.push({id:genId('q'), showId: show.id, payload, attempts:0, nextDelayMs:1000});
      saveState();
      updateQueuedBadge();
      toast('Submit failed. Queued for retry', true);
    }
  }
  async function sendWebhook(payload){
    const headers = {'Content-Type':'application/json'};
    if(state.webhook.headerName && state.webhook.secret){
      headers[state.webhook.headerName] = state.webhook.secret;
    }
    const res = await fetch(state.webhook.url, {
      method:'POST',
      headers,
      body: JSON.stringify(payload)
    });
    if(!res.ok){ throw new Error('HTTP '+res.status) }
    return res;
  }
  function updateQueuedBadge(){
    const n = state.queuedSends.length;
    queuedCount.textContent = String(n);
    queuedBadge.style.display = n ? 'inline-flex' : 'none';
  }
  function retryQueued(){
    if(!state.queuedSends.length){ toast('No queued payloads'); return }
    // iterate and schedule with per-item backoff
    state.queuedSends.slice().forEach(item=>{
      const delay = Math.min(item.nextDelayMs || 1000, 30000);
      setTimeout(async ()=>{
        try{
          await sendWebhook(item.payload);
          // remove from queue
          const idx = state.queuedSends.findIndex(x=>x.id===item.id);
          if(idx>=0){ state.queuedSends.splice(idx,1); saveState(); updateQueuedBadge(); toast('Queued send delivered') }
        }catch(err){
          // backoff
          item.attempts = (item.attempts||0)+1;
          item.nextDelayMs = Math.min((item.nextDelayMs||1000)*2, 120000);
          saveState();
          toast('Retry failed. Will require another retry', true);
        }
      }, delay);
    });
  }

  // Ensure content never sits under the sticky footer
  function adjustContainerBottomPadding(){
    const container = document.querySelector('.container');
    const footer = document.querySelector('.sticky-footer');
    if(!container || !footer) return;
    const footerHeight = Math.ceil(footer.getBoundingClientRect().height);
    const extraGapPx = 12; // breathing room above footer
    container.style.paddingBottom = (footerHeight + extraGapPx) + 'px';
  }
  // Initial call and on resize/layout changes
  adjustContainerBottomPadding();
  window.addEventListener('resize', adjustContainerBottomPadding);
  // Observe footer size changes (wraps at breakpoints)
  if('ResizeObserver' in window){
    const ro = new ResizeObserver(adjustContainerBottomPadding);
    const footerEl = document.querySelector('.sticky-footer');
    if(footerEl) ro.observe(footerEl);
  }

  // Edit modal
  function openEditModal(showId, entryId){
    const show = state.shows.find(s=>s.id===showId);
    const entry = show?.entries.find(e=>e.id===entryId);
    if(!entry) return;
    editingEntryRef = {showId, entryId};

    const form = el('editForm');
    form.innerHTML = ''; // rebuild with same fields as entry form, prefilled
    // Build clones with unique IDs
    const fields = buildEntryFieldsClone(entry);
    form.append(...fields);
    // open
    el('editModal').classList.add('open');
  }
  function closeEditModal(){
    el('editModal').classList.remove('open');
    editingEntryRef = null;
  }
  function saveEditEntry(){
    if(!editingEntryRef) return;
    const show = state.shows.find(s=>s.id===editingEntryRef.showId);
    const idx = show.entries.findIndex(e=>e.id===editingEntryRef.entryId);
    if(idx<0) return;
    const form = el('editForm');
    // Collect values from edit form
    const get = (id)=> qs(`#${id}`, form);
    const e = show.entries[idx];
    // Validate minimal
    const st = pillGet(form);
    if(!get('edit_unitId').value || !get('edit_planned').value || !get('edit_launched').value || !st){
      toast('Missing required fields', true); return;
    }
    if(get('edit_planned').value==='No' && st!=='No-launch'){ toast('If Planned is No, Status must be No-launch', true); return }
    if(get('edit_launched').value==='No' && st!=='No-launch'){ toast('If Launched is No, Status must be No-launch', true); return }
    if(get('edit_launched').value==='Yes' && st==='No-launch'){ toast('If Launched is Yes, Status cannot be No-launch', true); return }

    const prim = get('edit_primaryIssue').value;
    const sev = get('edit_severity').value;
    const other = get('edit_otherDetail').value.trim();
    if(st!=='Completed'){
      if(!prim || !sev){ toast('Issue and Severity required when not Completed', true); return }
      if(prim==='Other' && !other){ toast('Other detail required', true); return }
    }

    e.unitId = get('edit_unitId').value;
    e.planned = get('edit_planned').value;
    e.launched = get('edit_launched').value;
    e.status = st;
    e.primaryIssue = (st==='Completed') ? '' : prim;
    e.subIssue = (st==='Completed') ? '' : (get('edit_subIssue').value || '');
    e.otherDetail = (st==='Completed') ? '' : (prim==='Other'? other:'');
    e.severity = (st==='Completed') ? '' : sev;
    e.rootCause = (st==='Completed') ? '' : get('edit_rootCause').value;
    e.actions = (st==='Completed') ? [] : getSelectedActions(qs('#edit_actionsChips', form));
    e.operator = get('edit_operator').value || '';
    e.batteryId = get('edit_batteryId').value.trim();
    const dval = get('edit_delaySec').value;
    e.delaySec = dval ? Number(dval) : null;
    
    e.commandRx = get('edit_commandRx').value || '';
    e.notes = get('edit_entryNotes').value.trim();

    saveState();
    renderGroups();
    closeEditModal();
    toast('Entry updated');
  }

  function buildEntryFieldsClone(entry){
    const wrap = (child, cls='col-3')=>{
      const d = document.createElement('div'); d.className = cls; d.appendChild(child); return d;
    };
    const mkLabelInput = (id, labelText, node)=>{
      const l = document.createElement('label'); l.setAttribute('for', id); l.textContent = labelText;
      const w = document.createElement('div'); w.appendChild(l); node.id=id; node.className=''; node.style.width='100%'; node.style.minHeight='var(--tap-min)';
      w.appendChild(node); return w;
    };
    // unit
    const unit = document.createElement('select');
    const units = getDefaultUnits();
    if(entry.unitId && !units.includes(entry.unitId)) units.push(entry.unitId);
    unit.innerHTML = `<option value="">Select</option>`+units.map(u=>`<option ${entry.unitId===u?'selected':''}>${u}</option>`).join('');
    // planned
    const plan = document.createElement('select'); plan.innerHTML = opts(entry.planned);
    const launch = document.createElement('select'); launch.innerHTML = opts(entry.launched);
    // status pills
    const pills = pillBuild(entry.status);
    // issues
    const prim = document.createElement('select');
    prim.innerHTML = `<option value="">Select</option>` + PRIMARY_ISSUES.map(i=>`<option ${entry.primaryIssue===i?'selected':''}>${i}</option>`).join('');
    const sub = document.createElement('select');
    const subs = ISSUE_MAP[entry.primaryIssue]||[];
    sub.innerHTML = `<option value="">${subs.length?'Select':'N/A'}</option>`+subs.map(s=>`<option ${entry.subIssue===s?'selected':''}>${s}</option>`).join('');
    const other = document.createElement('input'); other.type='text'; other.value = entry.otherDetail||'';
    const sev = document.createElement('select'); sev.innerHTML = `<option value="">Select</option><option ${sel(entry.severity,'Critical show stop')}>Critical show stop</option><option ${sel(entry.severity,'Major visible')}>Major visible</option><option ${sel(entry.severity,'Minor contained')}>Minor contained</option>`;
    const root = document.createElement('select'); root.innerHTML = `<option value="">Select</option><option ${sel(entry.rootCause,'Hardware')}>Hardware</option><option ${sel(entry.rootCause,'Software')}>Software</option><option ${sel(entry.rootCause,'Ops')}>Ops</option><option ${sel(entry.rootCause,'Environment')}>Environment</option><option ${sel(entry.rootCause,'Unknown')}>Unknown</option>`;
    const acts = document.createElement('div'); acts.id='edit_actionsChips'; acts.className='actions-chips'; renderActionsChips(acts, entry.actions||[]);
    // others
    const op = document.createElement('select'); op.innerHTML = `<option value="">Select</option>` + (currentShow.crew||[]).map(n=>`<option ${sel(entry.operator,n)}>${n}</option>`).join('');
    const bat = document.createElement('input'); bat.type='text'; bat.value = entry.batteryId||'';
    const dly = document.createElement('input'); dly.type='number'; dly.step='0.1'; dly.min='0'; dly.value = (entry.delaySec!=null?String(entry.delaySec):'');
    
    const cmd = document.createElement('select'); cmd.innerHTML = `<option value="">Select</option><option ${sel(entry.commandRx,'Yes')}>Yes</option><option ${sel(entry.commandRx,'No')}>No</option>`;
    const note = document.createElement('input'); note.type='text'; note.value = entry.notes||'';

    // Reactive behaviors in edit
    prim.addEventListener('change', ()=>{
      const subs2 = ISSUE_MAP[prim.value]||[];
      sub.innerHTML = `<option value="">${subs2.length?'Select':'N/A'}</option>`+subs2.map(s=>`<option>${s}</option>`).join('');
      // Show or hide other detail
      qs('#wrap_edit_otherDetail').classList.toggle('hidden', prim.value!=='Other');
    });
    plan.addEventListener('change', ()=>{
      if(plan.value==='No'){ pillSet(pills,'No-launch'); }
    });
    launch.addEventListener('change', ()=>{
      if(launch.value==='No'){ pillSet(pills,'No-launch'); }
      else{ const st = pillGetRaw(pills); if(st==='No-launch' || !st) pillSet(pills,'Completed'); }
    });

    // Build grid
    const gridChildren = [
      wrap(mkLabelInput('edit_unitId', `${state.unitLabel} ID`, unit), 'col-2'),
      wrap(mkLabelInput('edit_planned', 'Planned to fly', plan), 'col-2'),
      wrap(mkLabelInput('edit_launched', 'Launched', launch), 'col-2'),
      wrap(pills, 'col-6'),

      wrap(mkLabelInput('edit_primaryIssue', 'Primary issue', prim), 'col-4'),
      wrap(mkLabelInput('edit_subIssue', 'Sub-issue', sub), 'col-4'),
      wrap(mkLabelInput('edit_otherDetail', 'Other detail', other), 'col-4').setAttribute ? null : null
    ].filter(Boolean);

    const otherWrap = gridChildren[6]; // may be undefined if filter trimmed
    if(otherWrap) otherWrap.id = 'wrap_edit_otherDetail';
    if(entry.primaryIssue!=='Other' || entry.status==='Completed'){ if(otherWrap) otherWrap.classList.add('hidden') }

    gridChildren.push(
      wrap(mkLabelInput('edit_severity', 'Severity', sev), 'col-4'),
      wrap(mkLabelInput('edit_rootCause', 'Root cause draft', root), 'col-4'),
      wrap(mkLabelInput('edit_actionsChips', 'Actions taken', acts), 'col-12'),

      wrap(mkLabelInput('edit_operator', 'Operator', op), 'col-3'),
      wrap(mkLabelInput('edit_batteryId', 'Battery ID', bat), 'col-3'),
      wrap(mkLabelInput('edit_delaySec', 'Launch delay seconds', dly), 'col-3'),
      
      wrap(mkLabelInput('edit_commandRx', 'Command received', cmd), 'col-3'),
      wrap(mkLabelInput('edit_entryNotes', 'Notes', note), 'col-9')
    );

    // Hide issue block if Completed
    const issues = [prim.parentElement.parentElement, sub.parentElement.parentElement, otherWrap, sev.parentElement.parentElement, root.parentElement.parentElement, acts.parentElement.parentElement];
    const toggleIssues = ()=>{
      const st = pillGetRaw(pills);
      const showIssues = st && st!=='Completed';
      issues.forEach(w=>{ if(w) w.classList.toggle('hidden', !showIssues); });
      if(prim.value!=='Other'){ if(otherWrap) otherWrap.classList.add('hidden'); }
    };
    toggleIssues();

    return gridChildren;

    // helpers
    function opts(v){ return `<option value="">Select</option><option ${sel(v,'Yes')}>Yes</option><option ${sel(v,'No')}>No</option>` }
    function sel(a,b){ return a===b ? 'selected':'' }
    function pillBuild(status){
      const wrap = document.createElement('div'); wrap.className='pills'; wrap.setAttribute('role','group'); wrap.setAttribute('aria-label','Status');
      const mk = (txt, cls)=>{
        const b = document.createElement('button'); b.type='button'; b.className=`pill ${cls}`;
        b.textContent = txt; b.dataset.status = txt; b.setAttribute('aria-pressed', status===txt ? 'true':'false');
        b.addEventListener('click', ()=>{ pillSet(wrap, txt); toggleIssues(); });
        return b;
      };
      wrap.append(mk('Completed','completed'), mk('No-launch','nolaunch'), mk('Abort','abort'));
      return wrap;
    }
    function pillSet(wrap, s){ qsa('.pill', wrap).forEach(b=>b.setAttribute('aria-pressed', b.dataset.status===s ? 'true':'false')) }
    function pillGetRaw(wrap){ const b = qsa('.pill', wrap).find(x=>x.getAttribute('aria-pressed')==='true'); return b? b.dataset.status:'' }
    function pillGet(formRoot){ return pillGetRaw(qs('.pills', formRoot)) }
  }

  // Helpers
  function clearErrors(){ qsa('.error').forEach(e=>e.hidden=true) }
  function showError(id){ el(id).hidden = false }
  function toast(msg, isErr){
    const t = el('toast');
    t.textContent = msg;
    t.classList.add('show');
    t.style.borderColor = isErr ? 'var(--danger)' : 'var(--border)';
    setTimeout(()=> t.classList.remove('show'), 1800);
  }
  function downloadFile(content, filename, type){
    const blob = new Blob([content], {type:type || 'application/octet-stream'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download=filename;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 500);
  }
  function csvEscape(s){
    if(s==null) return '';
    s = String(s);
    if(/[",;\r\n]/.test(s)){
      return `"${s.replace(/"/g,'""')}"`;
    }
    return s;
  }
  function genId(prefix){ return `${prefix}_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,8)}` }
  function pad2(n){ return String(n).padStart(2,'0') }
  function fmtDateInput(d){ return d.getFullYear()+'-'+pad2(d.getMonth()+1)+'-'+pad2(d.getDate()) }
  function formatDateUS(dateStr){
    if(!dateStr || dateStr === 'YYYY-MM-DD') return '';
    const parts = dateStr.split('-');
    if(parts.length === 3){
      const [year, month, day] = parts;
      return `${month}-${day}-${year}`;
    }
    return dateStr; // fallback to original if format is unexpected
  }
  function formatTime12Hour(timeStr){
    if(!timeStr || timeStr === 'HH:mm') return '';
    const parts = timeStr.split(':');
    if(parts.length === 2){
      const hours = parseInt(parts[0], 10);
      const minutes = parts[1];
      if(hours === 0){
        return `12:${minutes} AM`;
      } else if(hours < 12){
        return `${hours}:${minutes} AM`;
      } else if(hours === 12){
        return `12:${minutes} PM`;
      } else {
        return `${hours - 12}:${minutes} PM`;
      }
    }
    return timeStr; // fallback to original if format is unexpected
  }
  function compareShowDateTimeDesc(a,b){
    const ad = (a.date||'')+'T'+(a.time||'00:00'); const bd = (b.date||'')+'T'+(b.time||'00:00');
    return (bd.localeCompare(ad)) || 0;
  }
  function escapeHtml(s){
    return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // Crew chips
  function initCrewChipInput(container, initial, onChange){
    container.innerHTML = '';
    const input = document.createElement('input'); input.type='text'; input.placeholder = 'Type name and press Enter';
    const names = [...initial];
    container.appendChild(input);
    names.forEach(n=> container.insertBefore(chip(n), input));
    input.addEventListener('keydown', e=>{
      if(e.key==='Enter' || e.key===',' ){
        e.preventDefault();
        const v = input.value.trim();
        if(v && !names.includes(v)){
          names.push(v);
          container.insertBefore(chip(v), input);
          input.value='';
          onChange([...names]);
        }else{
          input.value='';
        }
      }
    });
    container.addEventListener('click', ()=> input.focus());
    function chip(name){
      const c = document.createElement('span'); c.className='chip'; c.setAttribute('aria-label', name);
      c.innerHTML = `<span>${escapeHtml(name)}</span><button class="x" aria-label="Remove">×</button>`;
      qs('.x', c).addEventListener('click', (e)=>{
        e.stopPropagation();
        const idx = names.indexOf(name); if(idx>=0){ names.splice(idx,1); c.remove(); onChange([...names]) }
      });
      return c;
    }
  }

  // Config toggle
  function toggleConfig(open){
    cfgBtn.setAttribute('aria-expanded', String(open));
    cfgPanel.classList.toggle('open', open);
  }

  // Sample data
  function loadSampleData(){
    const today = fmtDateInput(new Date());
    const defaultCrew = ['Alex','Blake','Casey','Dev'];
    const mkShow = (time, label)=>({
      id: genId('show'),
      date: today,
      time,
      label,
      crew: [...defaultCrew],
      leadPilot: defaultCrew[0],
      monkeyLead: defaultCrew[1],
      weather:{},
      notes:'Sample',
      entries:[]
    });
    const s1 = mkShow('18:00','Evening A');
    const s2 = mkShow('21:00','Evening B');
    const sampleEntries = [
      {unitId:'D1', planned:'Yes', launched:'Yes', launchTime:'18:02', status:'Completed', operator:'Alex', delaySec:1.2, commandRx:'Yes', notes:'OK'},
      {unitId:'D2', planned:'Yes', launched:'No', status:'No-launch', primaryIssue:'RF link', subIssue:'interference', severity:'Major visible', rootCause:'Environment', actions:['Logged only'], operator:'Blake', delaySec:null, commandRx:'No', notes:'RF noisy'},
      {unitId:'D3', planned:'Yes', launched:'Yes', launchTime:'18:03', status:'Abort', primaryIssue:'Command delay', subIssue:'network latency', severity:'Minor contained', rootCause:'Software', actions:['Retry launch'], operator:'Casey', delaySec:4.5, commandRx:'Yes', notes:'Late'},
      {unitId:'D4', planned:'No', launched:'No', status:'No-launch', primaryIssue:'Other', otherDetail:'Standby unit', severity:'Minor contained', operator:'Dev', commandRx:'', notes:'Reserve'}
    ];
    s1.entries = sampleEntries.map(e=>({ id:genId('entry'), ts:Date.now(), batteryId:'', ...e }));
    s2.entries = [
      {unitId:'D5', planned:'Yes', launched:'Yes', launchTime:'21:01', status:'Completed', operator:'Alex', delaySec:0.8, tracking:'Yes', commandRx:'Yes', notes:''},
      {unitId:'D6', planned:'Yes', launched:'Yes', launchTime:'21:02', status:'Abort', primaryIssue:'Battery', subIssue:'low voltage', severity:'Major visible', rootCause:'Hardware', actions:['Swap battery','Abort segment'], operator:'Blake', delaySec:2.1, tracking:'Yes', commandRx:'Yes', notes:'Voltage drop'}
    ].map(e=>({ id:genId('entry'), ts:Date.now(), batteryId:'', ...e }));
    state.shows = [s2, s1]; // newest first by later time
    state.currentShowId = s2.id;
    currentShow = s2;
    saveState();
    fillHeader(currentShow);
    initCrewChipInput(crewInput, currentShow.crew || [], names=>{ currentShow.crew=names; renderOperatorOptions(); saveState(); });
    renderOperatorOptions();
    renderGroups();
    toast('Sample data loaded');
  }

  function clearAllData(){
    if(!confirm('Clear all data? This cannot be undone.')) return;
    localStorage.removeItem(STORAGE_KEY);
    state = loadState();
    currentShow = ensureCurrentShow();
    onUnitLabelChange();
    fillHeader(currentShow);
    initCrewChipInput(crewInput, [], names=>{ currentShow.crew=names; renderOperatorOptions(); saveState(); });
    renderOperatorOptions();
    renderGroups();
    updateQueuedBadge();
    toast('All data cleared');
  }

  // Small helpers for edit builder
  function pillGet(root){ const b = qs('.pills .pill[aria-pressed="true"]', root); return b? b.dataset.status:'' }

})();
</script>
</body>
</html>